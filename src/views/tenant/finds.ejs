<%- include('../partials/header') %>

<div class="match-container">
  <h2>Encuentra tu piso</h2>

  <% if (!hasMore) { %>
    <div class="card empty">
      <p>No hay más pisos para mostrar ahora mismo.</p>
    </div>
  <% } else { %>
    <div class="card" id="card" data-id="<%= property.id %>">
      <div class="image-carousel" id="carousel">
        <button class="nav-btn left" id="btnPrev">&lt;</button>
        <img
          id="photo"
          src="<%= (Array.isArray(property.photos) && property.photos.length)
                ? (property.photos[0].startsWith('http') || property.photos[0].startsWith('/')
                    ? property.photos[0]
                    : '/uploads/' + property.photos[0])
                : '/images/placeholder.jpg' %>"
          alt="Foto del piso">
        <button class="nav-btn right" id="btnNext">&gt;</button>
      </div>

      <div class="info">
        <div class="tags">
          <div class="tag"><i class="fa-solid fa-ruler-combined"></i> <%= property.sizeM2 ?? '' %> m²</div>
          <div class="tag"><i class="fa-solid fa-bed"></i> <%= property.bedrooms ?? 0 %> habitaciones</div>
          <div class="tag"><%= property.stayType ?? '' %></div>
          <div class="tag"><i class="fa-solid fa-location-dot"></i> <%= property.neighborhood ?? '' %></div>
          <% if (typeof property.terrace !== 'undefined') { %>
            <div class="tag">Terraza: <%= property.terrace ? 'Sí' : 'No' %></div>
          <% } %>
          <% if (property.availableFrom) { %>
            <div class="tag"><i class="fa-solid fa-calendar-days"></i> <%= property.availableFrom %></div>
          <% } %>
          <% if (property.price) { %>
            <div class="tag">€ <%= property.price %>/mes</div>
          <% } %>
        </div>
      </div>

      <div class="actions">
        <button class="reject" id="btnReject">❌</button>
        <button class="like" id="btnLike">❤️</button>
      </div>
    </div>
  <% } %>
</div>

<script>
(() => {
  const card = document.getElementById('card');
  if (!card) return; // no hay pisos

  // Normaliza URLs de fotos: si no empiezan por http/ /, antepone /uploads/
  const normalize = u => (typeof u === 'string' && !u.startsWith('http') && !u.startsWith('/')) ? '/uploads/' + u : u;

  let photos = (<%- JSON.stringify(property.photos || []) %>).map(normalize);
  let photoIdx = 0;

  const photoEl = document.getElementById('photo');
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');
  const btnLike = document.getElementById('btnLike');
  const btnReject = document.getElementById('btnReject');

  const updatePhoto = () => {
    if (!photos.length) return;
    photoEl.src = photos[photoIdx];
  };

  btnPrev?.addEventListener('click', () => {
    if (!photos.length) return;
    photoIdx = (photoIdx - 1 + photos.length) % photos.length;
    updatePhoto();
  });

  btnNext?.addEventListener('click', () => {
    if (!photos.length) return;
    photoIdx = (photoIdx + 1) % photos.length;
    updatePhoto();
  });

  async function sendAction(action) {
    const id = card.dataset.id;
    const url = action === 'like'
      ? `/api/matches/${id}/like`
      : `/api/matches/${id}/reject`;

    btnLike.disabled = true;
    btnReject.disabled = true;

    try {
      const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      const data = await res.json();

      if (!data.ok) throw new Error('Respuesta no OK');

      if (!data.next) {
        card.outerHTML = `
          <div class="card empty">
            <p>No hay más pisos para mostrar ahora mismo.</p>
          </div>`;
        return;
      }

      const p = data.next;
      card.dataset.id = p.id;

      photos = Array.isArray(p.photos) ? p.photos.map(normalize) : [];
      photoIdx = 0;
      photoEl.src = photos.length ? photos[0] : '/images/placeholder.jpg';

      const tagsHtml = `
        <div class="tag"><i class="fa-solid fa-ruler-combined"></i> ${p.sizeM2 ?? ''} m²</div>
        <div class="tag"><i class="fa-solid fa-bed"></i> ${p.bedrooms ?? 0} habitaciones</div>
        <div class="tag">${p.stayType ?? ''}</div>
        <div class="tag"><i class="fa-solid fa-location-dot"></i> ${p.neighborhood ?? ''}</div>
        ${typeof p.terrace !== 'undefined' ? `<div class="tag">Terraza: ${p.terrace ? 'Sí' : 'No'}</div>` : ''}
        ${p.availableFrom ? `<div class="tag"><i class="fa-solid fa-calendar-days"></i> ${p.availableFrom}</div>` : ''}
        ${p.price ? `<div class="tag">€ ${p.price}/mes</div>` : ''}
      `;
      card.querySelector('.tags').innerHTML = tagsHtml;

    } catch (err) {
      console.error(err);
      alert('Ocurrió un error. Intenta de nuevo.');
    } finally {
      btnLike.disabled = false;
      btnReject.disabled = false;
    }
  }

  btnLike?.addEventListener('click', () => sendAction('like'));
  btnReject?.addEventListener('click', () => sendAction('reject'));
})();
</script>

<%- include('../partials/footer') %>